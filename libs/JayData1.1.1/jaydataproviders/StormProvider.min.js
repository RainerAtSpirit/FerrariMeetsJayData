// JayData 1.1.1
// Dual licensed under MIT and GPL v2
// Copyright JayStack Technologies (http://jaydata.org/licensing)
//
// JayData is a standards-based, cross-platform Javascript library and a set of
// practices to access and manipulate data from various online and offline sources.
//
// Credits:
//     Hajnalka Battancs, Dániel József, János Roden, László Horváth, Péter Nochta
//     Péter Zentai, Róbert Bónay, Szabolcs Czinege, Viktor Borza, Viktor Lázár,
//     Zoltán Gyebrovszki
//
// More info: http://jaydata.org
$C("$data.storageProviders.Storm.StormProvider",$data.StorageProviderBase,null,{constructor:function(a,h){this.context=h;this.providerConfiguration=$data.typeSystem.extend({url:"http://localhost:3000/"},a)},initializeStore:function(a){a=$data.typeSystem.createCallbackSetting(a);a.success(this.context)},executeQuery:function(a,h){callBack=$data.typeSystem.createCallbackSetting(h);a.modelBinderConfig={};Container.createModelBinderConfigCompiler(a,this.includes,!1).Visit(a.expression);var b=(new $data.storageProviders.InMemory.InMemoryCompiler(this)).compile(a),
e=a.getEntitySets().map(function(a){return a.name}),d;for(d in b)if(0==d.indexOf("$"))if("function"===typeof b[d])b[d]=b[d].toString().replace("function anonymous","function").replace(/\n/g," ");else if(b[d]instanceof Array&&"$order"===d)for(var c=0;c<b[d].length;c++){if("function"===typeof b[d][c]){var g=b[d][c].ASC;b[d][c]=b[d][c].toString().replace("function anonymous","function").replace(/\n/g," ")}else g=b[d][c].ASC;b[d][c]={fn:b[d][c],direction:g}}$data.ajax({url:this.providerConfiguration.url,
dataType:"json",data:{entitySet:e[0],expression:b},success:function(b){a.rawDataList="undefined"!==typeof b.length?b:[{cnt:b}];a.context=this;callBack.success(a)},error:function(a,b,c){b={};try{b=JSON.parse(a.responseText).error}catch(d){b=c+": "+a.responseText}callBack.error(b)}})},saveChanges:function(a,h){if(h.length){for(var b=this.buildIndependentBlocks(h),e=[],d={},c=0;c<b.length;c++)for(var g=0;g<b[c].length;g++){e.push(b[c][g].data);var f=d[b[c][g].entitySet.name];f||(f={},d[b[c][g].entitySet.name]=
f);switch(b[c][g].data.entityState){case $data.EntityState.Unchanged:continue;case $data.EntityState.Added:f.insertAll||(f.insertAll=[]);f.insertAll.push(this.save_getInitData(b[c][g],e));break;case $data.EntityState.Modified:f.updateAll||(f.updateAll=[]);f.updateAll.push(this.save_getInitData(b[c][g],e));break;case $data.EntityState.Deleted:f.removeAll||(f.removeAll=[]);f.removeAll.push(this.save_getInitData(b[c][g],e));break;default:Guard.raise(new Exception("Not supported Entity state"))}}$data.ajax({url:this.providerConfiguration.url,
type:"post",dataType:"json",data:{items:JSON.stringify(d)},success:function(b){a.success(b)},error:function(b,c,d){c={};try{c=JSON.parse(b.responseText).error}catch(e){c=d+": "+b.responseText}a.error(c)}})}else a.success(0)},save_getInitData:function(a,h){a.physicalData=this.context._storageModel.getStorageModel(a.data.getType()).PhysicalType.convertTo(a.data,h);var b={};a.physicalData.getType().memberDefinitions.asArray().forEach(function(e){if(e.kind==$data.MemberTypes.navProperty||e.kind==$data.MemberTypes.complexProperty||
e.kind==$data.MemberTypes.property&&!e.notMapped)b[e.name]=a.physicalData[e.name]},this);return b},supportedDataTypes:{value:[$data.Integer,$data.String,$data.Number,$data.Blob,$data.Boolean,$data.Date],writable:!1},supportedBinaryOperators:{value:{equal:{mapTo:" == ",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression]},notEqual:{mapTo:" != ",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression]},equalTyped:{mapTo:" === ",
dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression]},notEqualTyped:{mapTo:" !== ",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression]},greaterThan:{mapTo:" > ",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression]},greaterThanOrEqual:{mapTo:" >= ",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression]},lessThan:{mapTo:" < ",
dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression]},lessThenOrEqual:{mapTo:" <= ",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression]},or:{mapTo:" || ",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression]},and:{mapTo:" && ",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression]},"in":{mapTo:".indexOf(",allowedIn:[$data.Expressions.FilterExpression],
rightValue:") > -1",reverse:!0}}},supportedUnaryOperators:{value:{not:{mapTo:"!"}}},supportedSetOperations:{value:{filter:{},map:{},length:{},forEach:{},toArray:{},single:{},take:{},skip:{},orderBy:{},orderByDescending:{},first:{},include:{}},enumerable:!0,writable:!0},fieldConverter:{value:{fromDb:{"$data.Integer":function(a){return a},"$data.Number":function(a){return a},"$data.Date":function(a){return"string"===typeof a?new Date(a):a},"$data.String":function(a){return a},"$data.Boolean":function(a){return a},
"$data.Blob":function(a){return a},"$data.Object":function(a){return void 0===a?new $data.Object:JSON.parse(a)},"$data.Array":function(a){return void 0===a?new $data.Array:JSON.parse(a)}},toDb:{"$data.Integer":function(a){return a},"$data.Number":function(a){return a},"$data.Date":function(a){return'ISODate("'+a.toISOString()+'")'},"$data.String":function(a){return'"'+a+'"'},"$data.Boolean":function(a){return a},"$data.Blob":function(a){return a},"$data.Object":function(a){return JSON.stringify(a)},
"$data.Array":function(a){return JSON.stringify(a)}}}}},{isSuppported:{get:function(){return"XMLHttpRequest"in window}}});$data.storageProviders.Storm.StormProvider.isSupported&&$data.StorageProviderBase.registerProvider("storm",$data.storageProviders.Storm.StormProvider);
