// JayData 1.1.1
// Dual licensed under MIT and GPL v2
// Copyright JayStack Technologies (http://jaydata.org/licensing)
//
// JayData is a standards-based, cross-platform Javascript library and a set of
// practices to access and manipulate data from various online and offline sources.
//
// Credits:
//     Hajnalka Battancs, Dániel József, János Roden, László Horváth, Péter Nochta
//     Péter Zentai, Róbert Bónay, Szabolcs Czinege, Viktor Borza, Viktor Lázár,
//     Zoltán Gyebrovszki
//
// More info: http://jaydata.org
$C("$data.modelBinder.mongoDBModelBinderConfigCompiler",$data.modelBinder.ModelBinderConfigCompiler,null,{_addPropertyToModelBinderConfig:function(b,a){var c=this._query.context._storageModel.getStorageModel(b);b.memberDefinitions?b.memberDefinitions.getPublicMappedProperties().forEach(function(b){if(!c||c&&!c.Associations[b.name]&&!c.ComplexTypes[b.name])!c&&0>this._query.context.storageProvider.supportedDataTypes.indexOf(Container.resolveType(b.dataType))?(a.selectModelBinderProperty(b.name),a.modelBinderConfig.$type=
Container.resolveType(b.dataType),a.modelBinderConfig.$selector=this._isoDataProvider?["json:"+b.name+".results","json:"+b.name]:"json:"+b.name,this._addPropertyToModelBinderConfig(Container.resolveType(b.dataType),a),a.popModelBinderProperty()):(b.key&&a.addKeyField(b.computed?"_id":b.name),a.modelBinderConfig[b.name]=b.concurrencyMode===$data.ConcurrencyMode.Fixed?{$selector:"json:__metadata",$source:"etag"}:b.computed?"_id":b.name)},this):(a._binderConfig.$item={},a.modelBinderConfig=a._binderConfig.$item);
c&&this._addComplexTypeProperties(c.ComplexTypes,a)}});
$C("$data.storageProviders.mongoDB.mongoDBProjectionCompiler",$data.Expressions.EntityExpressionVisitor,null,{constructor:function(){},compile:function(b,a){this.Visit(b,a)},VisitProjectionExpression:function(b,a){this.Visit(b.selector,a)},VisitParametricQueryExpression:function(b,a){this.Visit(b.expression,a)},VisitObjectLiteralExpression:function(b,a){this.hasObjectLiteral=!0;b.members.forEach(function(b){this.Visit(b,a)},this)},VisitObjectFieldExpression:function(b,a){this.Visit(b.expression,a)},
VisitComplexTypeExpression:function(b,a){this.Visit(b.source,a);this.Visit(b.selector,a)},VisitEntityFieldExpression:function(b,a){this.Visit(b.source,a);this.Visit(b.selector,a)},VisitEntityExpression:function(b,a){this.Visit(b.source,a)},VisitEntitySetExpression:function(b,a){b.source instanceof $data.Expressions.EntityExpression&&this.Visit(b.source,a);b.selector instanceof $data.Expressions.AssociationInfoExpression&&this.Visit(b.selector,a)},VisitAssociationInfoExpression:function(){},VisitMemberInfoExpression:function(b,
a){a.options.fields||(a.options.fields={_id:1});a.options.fields[b.memberName]||(a.options.fields[b.memberName]=1)},VisitConstantExpression:function(){}});
$C("$data.storageProviders.mongoDB.mongoDBWhereCompiler",$data.Expressions.EntityExpressionVisitor,null,{constructor:function(b,a){this.provider=b;this.lambdaPrefix=a},compile:function(b,a){this.Visit(b,a)},VisitParametricQueryExpression:function(b,a){this.Visit(b.expression,a)},VisitUnaryExpression:function(b,a){a.unary=b.nodeType;this.Visit(b.operand,a)},VisitSimpleBinaryExpression:function(b,a){b.nodeType==$data.Expressions.ExpressionType.Or?a.or=!0:b.nodeType==$data.Expressions.ExpressionType.And&&
(a.and=!0);this.Visit(b.left,a);this.Visit(b.right,a);if(b.nodeType==$data.Expressions.ExpressionType.Or&&a.stackOr&&a.stackOr.length){for(var c=[];a.stackOr.length;){var e=a.stackOr.pop(),g={};g[e.field]=e.query;c.push(g);delete a.query[e.field]}1==c.length?a.and?(a.stackAnd||(a.stackAnd=[]),a.stackAnd.push({field:"$or",query:[c[0]]})):a.query=c[0]:a.and?(a.stackAnd||(a.stackAnd=[]),a.stackAnd.push({field:"$or",query:c})):a.query.$or=c;a.or=!1}else if(b.nodeType==$data.Expressions.ExpressionType.And&&
a.stackAnd&&a.stackAnd.length){for(c=[];a.stackAnd.length;)e=a.stackAnd.pop(),g={},g[e.field]=e.query,c.push(g),delete a.query[e.field];1==c.length?a.or?(a.stackOr||(a.stackOr=[]),a.stackOr.push({field:"$and",query:[c[0]]})):a.query=c[0]:a.or?(a.stackOr||(a.stackOr=[]),a.stackOr.push({field:"$and",query:c})):a.query.$and=c;a.and=!1}else b.nodeType!==$data.Expressions.ExpressionType.And&&(b.nodeType==$data.Expressions.ExpressionType.Equal?(e=a.value,a.entityType?e=this.provider.fieldConverter.toDb[Container.resolveName(Container.resolveType(a.entityType.memberDefinitions.getMember(a.field).type))](e):
a.valueType&&(e=this.provider.fieldConverter.toDb[Container.resolveName(Container.resolveType(valueType))](e)),a.query[a.field]=e):b.nodeType==$data.Expressions.ExpressionType.In&&a.unary==$data.Expressions.ExpressionType.Not?(a.query[a.field]||(a.query[a.field]={}),a.query[a.field].$nin=a.value,a.unary=void 0):(a.query[a.field]||(a.query[a.field]={}),a.query[a.field][b.resolution.mapTo]=a.value),a.or?(a.stackOr||(a.stackOr=[]),a.stackOr.push({field:a.field,query:a.query[a.field]})):a.and&&(a.stackAnd||
(a.stackAnd=[]),a.stackAnd.push({field:a.field,query:a.query[a.field]})),a.field=void 0,a.value=void 0)},VisitEntityFieldExpression:function(b,a){this.Visit(b.source,a);this.Visit(b.selector,a)},VisitAssociationInfoExpression:function(b,a){a.data+=b.associationInfo.FromPropertyName},VisitMemberInfoExpression:function(b,a){a.query[b.memberName]||(a.query[b.memberName]=null);a.field=b.memberName},VisitQueryParameterExpression:function(b,a){a.data+=this.provider.fieldConverter.toDb[b.type](b.value)},
VisitEntityFieldOperationExpression:function(b,a){Guard.requireType("expression.operation",b.operation,$data.Expressions.MemberInfoExpression);this.Visit(b.source.selector,a);var c=b.operation.memberDefinition,e=c.mapTo||c.name,g=0;(c.parameters||[{name:"@expression"}]).map(function(a){return"@expression"===a.name?b.source:b.parameters[g++]}).forEach(function(b){this.Visit(b,a)},this);a.query[a.field]||(a.query[a.field]={});switch(e){case "contains":a.query[a.field].$regex=a.value;break;case "startsWith":a.query[a.field].$regex=
"^"+a.value;break;case "endsWith":a.query[a.field].$regex=a.value+"$"}},VisitConstantExpression:function(b,a){var c=Container.getTypeName(b.value);a.valueType=c;a.value=b.value},VisitEntityExpression:function(b,a){a.entityType=b.entityType;this.Visit(b.source,a)},VisitEntitySetExpression:function(b,a){this.Visit(b.source,a);b.selector instanceof $data.Expressions.AssociationInfoExpression&&(this.Visit(b.selector,a),a.data+="/")},VisitFrameOperationExpression:function(b,a){this.Visit(b.source,a);Guard.requireType("expression.operation",
b.operation,$data.Expressions.MemberInfoExpression);var c=b.operation.memberDefinition;a.data+=c.mapTo||c.name;a.data+="(";for(var e=0,g=(c.parameters||[{name:"@expression"}]).map(function(a){return"@expression"===a.name?b.source:b.parameters[e++]}),d=0;d<g.length;d++){var f=g[d];if(f.value instanceof $data.Queryable){var h=new c.frameType(f.value.expression),f=Container.createQueryExpressionCreator(f.value.entityContext).Visit(h),h={data:""};(new $data.storageProviders.mongoDB.mongoDBWhereCompiler(this.provider,
!0)).compile(f,h);a.data+=h.lambda+": "+h.data}}a.data+=")"}});
$C("$data.storageProviders.mongoDB.mongoDBOrderCompiler",$data.storageProviders.mongoDB.mongoDBWhereCompiler,null,{constructor:function(b){this.provider=b},compile:function(b,a){this.Visit(b,a)},VisitOrderExpression:function(b,a){var c={data:""};this.Visit(b.selector,c);a.options.sort||(a.options.sort={});a.options.sort[c.data]=b.nodeType==$data.Expressions.ExpressionType.OrderByDescending?-1:1},VisitParametricQueryExpression:function(b,a){this.Visit(b.expression,a)},VisitEntityFieldExpression:function(b,
a){this.Visit(b.source,a);this.Visit(b.selector,a)},VisitComplexTypeExpression:function(b,a){this.Visit(b.source,a);this.Visit(b.selector,a)},VisitEntitySetExpression:function(b,a){b.selector instanceof $data.Expressions.AssociationInfoExpression&&(this.Visit(b.source,a),this.Visit(b.selector,a))},VisitAssociationInfoExpression:function(){},VisitEntityExpression:function(b,a){this.Visit(b.source,a);this.Visit(b.selector,a)},VisitMemberInfoExpression:function(b,a){a.data+=b.memberName}});
$C("$data.storageProviders.mongoDB.mongoDBPagingCompiler",$data.Expressions.EntityExpressionVisitor,null,{constructor:function(b){this.provider=b},compile:function(b,a){this.Visit(b,a)},VisitPagingExpression:function(b,a){var c={data:0};this.Visit(b.amount,c);switch(b.nodeType){case $data.Expressions.ExpressionType.Skip:a.options.skip=c.data;break;case $data.Expressions.ExpressionType.Take:a.options.limit=c.data;break;default:Guard.raise("Not supported nodeType")}},VisitConstantExpression:function(b,
a){a.data+=b.value}});
$C("$data.storageProviders.mongoDB.mongoDBCompiler",$data.Expressions.EntityExpressionVisitor,null,{constructor:function(){this.context={};this.provider={};this.mainEntitySet=this.includes=null},compile:function(b){this.provider=b.context.storageProvider;this.context=b.context;this.mainEntitySet=b.context.getEntitySetFromElementType(b.defaultType);b.find={query:{},options:{}};b.modelBinderConfig={};Container.createmongoDBModelBinderConfigCompiler(b,this.includes,!1).Visit(b.expression);this.Visit(b.expression,
b.find);delete b.find.field;delete b.find.value;delete b.find.data;delete b.find.stack;delete b.find.or;return b},VisitOrderExpression:function(b,a){this.Visit(b.source,a);Container.createmongoDBOrderCompiler(this.provider).compile(b,a)},VisitPagingExpression:function(b,a){this.Visit(b.source,a);Container.createmongoDBPagingCompiler().compile(b,a)},VisitFilterExpression:function(b,a){this.Visit(b.source,a);var c=Container.createmongoDBWhereCompiler(this.provider);a.data="";c.compile(b.selector,a)},
VisitProjectionExpression:function(b,a){this.Visit(b.source,a);Container.createmongoDBProjectionCompiler(this.context).compile(b,a)}});
$C("$data.storageProviders.mongoDB.mongoDBProvider",$data.StorageProviderBase,null,{constructor:function(b,a){this.driver=$data.mongoDBDriver;this.context=a;this.providerConfiguration=$data.typeSystem.extend({dbCreation:$data.storageProviders.DbCreationType.DropTableIfChanged,address:"127.0.0.1",port:27017,serverOptions:{},databaseName:"test"},b)},_getServer:function(){return this.providerConfiguration.slave&&this.providerConfiguration.slave.address&&this.providerConfiguration.slave.port?new this.driver.ReplSetServers([new this.driver.Server(this.providerConfiguration.address,
this.providerConfiguration.port,this.providerConfiguration.serverOptions),new this.driver.Server(this.providerConfiguration.slave.address,this.providerConfiguration.slave.port,this.providerConfiguration.slave.serverOptions||{})]):this.driver.Server(this.providerConfiguration.address,this.providerConfiguration.port,this.providerConfiguration.serverOptions)},initializeStore:function(b){var a=this,b=$data.typeSystem.createCallbackSetting(b);switch(this.providerConfiguration.dbCreation){case $data.storageProviders.DbCreationType.DropAllExistingTables:(new this.driver.Db(this.providerConfiguration.databaseName,
this._getServer(),{})).open(function(c,e){c&&b.error(c);var g=0,d;for(d in a.context._entitySetReferences)a.context._entitySetReferences.hasOwnProperty(d)&&g++;for(d in a.context._entitySetReferences)a.context._entitySetReferences.hasOwnProperty(d)&&e.dropCollection(a.context._entitySetReferences[d].tableName,function(){0==--g&&(b.success(a.context),e.close())})});break;default:b.success(this.context)}},executeQuery:function(b,a){var c=this,a=$data.typeSystem.createCallbackSetting(a);this.entitySet=
b.context.getEntitySetFromElementType(b.defaultType);(new $data.storageProviders.mongoDB.mongoDBCompiler).compile(b);(new this.driver.Db(this.providerConfiguration.databaseName,this._getServer(),{})).open(function(e,g){e&&a.error(e);var d=new c.driver.Collection(g,c.entitySet.tableName),f=b.find,h=function(e,d){e&&a.error(e);b.rawDataList=d instanceof Array?d:[{cnt:d}];b.context=c.context;a.success(b);g.close()};switch(b.expression.nodeType){case $data.Expressions.ExpressionType.Count:d.find(f.query,
f.options).count(h);break;default:d.find(f.query,f.options).toArray(h)}})},_saveCollections:function(b,a){var c=this,e=0,g=0,d=function(b){0==--g&&b()},f=function(a,d,g){for(var f=[],j=0;j<d.insertAll.length;j++){for(var m=d.insertAll[j],l=Container.resolveType(m.type).memberDefinitions.getPublicMappedProperties(),i=0;i<l.length;i++){var n=l[i];n.computed||(m.data[n.name]=c.fieldConverter.toDb[Container.resolveName(Container.resolveType(n.type))](m.data[n.name]))}f.push(m.data)}g.insert(f,{safe:!0},
function(f,i){f&&b.error(f);for(var j=0;j<i.length;j++)for(var k=i[j],l=d.insertAll[j],n=Container.resolveType(l.type).memberDefinitions.getPublicMappedProperties(),m=0;m<n.length;m++){var p=n[m];l.entity[p.name]=c.fieldConverter.fromDb[Container.resolveName(Container.resolveType(p.type))](k[p.computed?"_id":p.name])}e+=i.length;d.removeAll&&d.removeAll.length?o(a,d,g):d.updateAll&&d.updateAll.length?h(a,d,g):(b.success(e),a.close())})},h=function(a,f,h){g=f.updateAll.length;for(var k=0;k<f.updateAll.length;k++){for(var j=
f.updateAll[k],m={},l=Container.resolveType(j.type).memberDefinitions.getKeyProperties(),i=0;i<l.length;i++){var n=l[i];m[n.computed?"_id":n.name]=c.fieldConverter.toDb[Container.resolveName(Container.resolveType(n.type))](j.data[n.computed?"_id":n.name])}l={};n=Container.resolveType(j.type).memberDefinitions.getPublicMappedProperties();for(i=0;i<n.length;i++){var o=n[i];o.computed||(l[o.name]=j.data[o.name])}h.update(m,{$set:l},{safe:!0},function(c){c&&b.error(c);e++;d(function(){b.success(e);a.close()})})}},
o=function(a,f,o){g=f.removeAll.length;for(var k=0;k<f.removeAll.length;k++){for(var j=f.removeAll[k],m=Container.resolveType(j.type).memberDefinitions.getKeyProperties(),l=0;l<m.length;l++){var i=m[l];j.data[i.computed?"_id":i.name]=c.fieldConverter.toDb[Container.resolveName(Container.resolveType(i.type))](j.data[i.computed?"_id":i.name])}m=Container.resolveType(j.type).memberDefinitions.getPublicMappedProperties();for(l=0;l<m.length;l++)i=m[l],i.computed||(j.data[i.name]=c.fieldConverter.toDb[Container.resolveName(Container.resolveType(i.type))](j.data[i.name]));
o.remove(j.data,{safe:!0},function(c,g){c&&b.error(c);e+=g;d(function(){f.updateAll&&f.updateAll.length?h(a,f,o):(b.success(e),a.close())})})}};(new this.driver.Db(this.providerConfiguration.databaseName,this._getServer(),{})).open(function(e,d){e&&b.error(e);for(var g in a)if(a.hasOwnProperty(g)){var k=a[g],j=new c.driver.Collection(d,g);k.insertAll&&k.insertAll.length?f(d,k,j):k.removeAll&&k.removeAll.length?o(d,k,j):k.updateAll&&k.updateAll.length?h(d,k,j):(b.success(0),d.close())}})},saveChanges:function(b,
a){if(a.length){for(var c=this.buildIndependentBlocks(a),e=[],g={},d=0;d<c.length;d++)for(var f=0;f<c[d].length;f++){e.push(c[d][f].data);var h=g[c[d][f].entitySet.name];h||(h={},g[c[d][f].entitySet.name]=h);var o={entity:c[d][f].data,data:this.save_getInitData(c[d][f],e),type:Container.resolveName(c[d][f].data.getType())};switch(c[d][f].data.entityState){case $data.EntityState.Unchanged:continue;case $data.EntityState.Added:h.insertAll||(h.insertAll=[]);h.insertAll.push(o);break;case $data.EntityState.Modified:h.updateAll||
(h.updateAll=[]);h.updateAll.push(o);break;case $data.EntityState.Deleted:h.removeAll||(h.removeAll=[]);h.removeAll.push(o);break;default:Guard.raise(new Exception("Not supported Entity state"))}}this._saveCollections(b,g)}else b.success(0)},save_getInitData:function(b,a){b.physicalData=this.context._storageModel.getStorageModel(b.data.getType()).PhysicalType.convertTo(b.data,a);var c={};b.physicalData.getType().memberDefinitions.asArray().forEach(function(a){if(a.kind==$data.MemberTypes.navProperty||
a.kind==$data.MemberTypes.complexProperty||a.kind==$data.MemberTypes.property&&!a.notMapped)c[a.computed?"_id":a.name]=b.physicalData[a.name]},this);return c},supportedDataTypes:{value:[$data.Integer,$data.String,$data.Number,$data.Blob,$data.Boolean,$data.Date,$data.ObjectID],writable:!1},supportedBinaryOperators:{value:{equal:{mapTo:":",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression]},notEqual:{mapTo:"$ne",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression]},equalTyped:{mapTo:":",
dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression]},notEqualTyped:{mapTo:"$ne",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression]},greaterThan:{mapTo:"$gt",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression]},greaterThanOrEqual:{mapTo:"$gte",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression]},lessThan:{mapTo:"$lt",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression]},lessThenOrEqual:{mapTo:"$lte",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression]},
or:{mapTo:"$or",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression]},and:{mapTo:"$and",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression]},"in":{mapTo:"$in",allowedIn:[$data.Expressions.FilterExpression]}}},supportedUnaryOperators:{value:{not:{mapTo:"$nor"}}},supportedFieldOperations:{value:{contains:{dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression],parameters:[{name:"substring",dataType:"string"}]},startsWith:{dataType:"string",allowedIn:[$data.Expressions.FilterExpression],
parameters:[{name:"@expression",dataType:"string"},{name:"strFragment",dataType:"string"}]},endsWith:{dataType:"string",allowedIn:[$data.Expressions.FilterExpression],parameters:[{name:"@expression",dataType:"string"},{name:"strFragment",dataType:"string"}]}},enumerable:!0,writable:!0},supportedSetOperations:{value:{filter:{},map:{},length:{},forEach:{},toArray:{},single:{},take:{},skip:{},orderBy:{},orderByDescending:{},first:{}},enumerable:!0,writable:!0},fieldConverter:{value:{fromDb:{"$data.Integer":function(b){return b},
"$data.Number":function(b){return b},"$data.Date":function(b){return b?new Date(b):b},"$data.String":function(b){return b},"$data.Boolean":function(b){return b},"$data.Blob":function(b){return b},"$data.Object":function(b){return void 0===b?new $data.Object:JSON.parse(b)},"$data.Array":function(b){return void 0===b?new $data.Array:JSON.parse(b)},"$data.ObjectID":function(b){return b?(new Buffer(b.toString(),"ascii")).toString("base64"):b}},toDb:{"$data.Integer":function(b){return b},"$data.Number":function(b){return b},
"$data.Date":function(b){return b},"$data.String":function(b){return b},"$data.Boolean":function(b){return b},"$data.Blob":function(b){return b},"$data.Object":function(b){return JSON.stringify(b)},"$data.Array":function(b){return JSON.stringify(b)},"$data.ObjectID":function(b){return b&&"string"===typeof b?new $data.mongoDBDriver.ObjectID.createFromHexString((new Buffer(b,"base64")).toString("ascii")):b}}}}},{isSupported:{get:function(){return!$data.mongoDBDriver?!1:!0},set:function(){}}});
$data.storageProviders.mongoDB.mongoDBProvider.isSupported&&$data.StorageProviderBase.registerProvider("mongoDB",$data.storageProviders.mongoDB.mongoDBProvider);
